@{
    ViewBag.Title = "This is geolocation test page";
    Layout = "~/Views/Shared/MasterSub.cshtml";      
}


<input id="address" type="hidden" style="width: 500px" value="@ViewBag.address" />
<input id="range" type="hidden" style="width: 100px" value="@ViewBag.range" />
<input id="category" type="hidden" style="width: 100px" value="@ViewBag.category" />
<input id="brand" type="hidden" style="width: 100px" value="@ViewBag.brand" />
<input id="search" type="hidden" style="width: 100px" value="@ViewBag.search" />
<input id="form" type="hidden" style="width: 100px" value="@ViewBag.form" />

<div id="content_sub">
    <div id="menu">
        <table>
            <tr>
                <td id="tabMap" onclick="displayMap()" class="active">
                    <img src="../images/icon_map.jpg" />
                    <strong>Bản đồ</strong>
                </td>
                <td id="tabList" onclick="displayList()">
                    <img src="../images/icon_list.jpg" />
                    <strong>Danh sách</strong>
                </td>
            </tr>
        </table>
    </div>
    <div id="noidungchinh">
        <div id="map">
            <div id="googleMap"></div>
            <div id="btn_more">
                <input type="button" id="btn_xemthemMap" value="Xem thêm" />
            </div>
        </div>
        <div id="list" class="hidden">
            <div id="object">
                <table style="width: 100%;">
                    <tr>
                        <td valign="top">
                            <img id="photo" src="../images/photo1.jpg" /></td>

                        <td valign="top">
                            <h2>KFC Hồ Biểu Chánh</h2>
                            <p>Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book.</p>
                            <p><a href="thongtinchitiet.html" class="lienket"><strong>Xem chi tiết</strong></a> | <a href="#" class="lienket"><strong>Đường đi</strong></a></p>
                        </td>
                    </tr>
                </table>
            </div>
            <div id="object">
                <table style="width: 100%;">
                    <tr>
                        <td valign="top">
                            <img id="photo" src="../images/photo1.jpg" /></td>

                        <td valign="top">
                            <h2>KFC Hồ Biểu Chánh</h2>
                            <p>Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book.</p>
                            <p><a href="thongtinchitiet.html" class="lienket"><strong>Xem chi tiết</strong></a> | <a href="#" class="lienket"><strong>Đường đi</strong></a></p>
                        </td>
                    </tr>
                </table>
            </div>
            <div id="object">
                <table style="width: 100%;">
                    <tr>
                        <td valign="top">
                            <img id="photo" src="../images/photo1.jpg" /></td>

                        <td valign="top">
                            <h2>KFC Hồ Biểu Chánh</h2>
                            <p>Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book.</p>
                            <p><a href="thongtinchitiet.html" class="lienket"><strong>Xem chi tiết</strong></a> | <a href="#" class="lienket"><strong>Đường đi</strong></a></p>
                        </td>
                    </tr>
                </table>
            </div>
            <div id="object">
                <table style="width: 100%;">
                    <tr>
                        <td valign="top">
                            <img id="photo" src="../images/photo1.jpg" /></td>

                        <td valign="top">
                            <h2>KFC Hồ Biểu Chánh</h2>
                            <p>Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book.</p>
                            <p><a href="thongtinchitiet.html" class="lienket"><strong>Xem chi tiết</strong></a> | <a href="#" class="lienket"><strong>Đường đi</strong></a></p>
                        </td>
                    </tr>
                </table>
            </div>
            <div id="object">
                <table style="width: 100%;">
                    <tr>
                        <td valign="top">
                            <img id="photo" src="../images/photo1.jpg" /></td>

                        <td valign="top">
                            <h2>KFC Hồ Biểu Chánh</h2>
                            <p>Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book.</p>
                            <p><a href="thongtinchitiet.html" class="lienket"><strong>Xem chi tiết</strong></a> | <a href="#" class="lienket"><strong>Đường đi</strong></a></p>
                        </td>
                    </tr>
                </table>
            </div>
            <div id="object">
                <table style="width: 100%;">
                    <tr>
                        <td valign="top">
                            <img id="photo" src="../images/photo1.jpg" /></td>

                        <td valign="top">
                            <h2>KFC Hồ Biểu Chánh</h2>
                            <p>Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book.</p>
                            <p><a href="thongtinchitiet.html" class="lienket"><strong>Xem chi tiết</strong></a> | <a href="#" class="lienket"><strong>Đường đi</strong></a></p>
                        </td>
                    </tr>
                </table>
            </div>
            <div id="btn_more">
                <input type="button" id="btn_xemthemList" value="Xem thêm" />
            </div>
        </div>
        <div id="cactienich">
            <table id="tableTienich" style="width: 240px; height: 718px;">
                <tr>
                    <td id="tbtable" style="display: none;" valign="top">
                        <p>
                            <strong>Các tiện ích:</strong>
                        </p>
                        <br />
                        <div id="property">
                        </div>
                    </td>
                    <td style="width: 25px;"><a id="hrfClose" style="display: none; cursor: pointer;" onclick="hidePanel()">
                        <img src="../images/button_close.jpg" /></a><a id="hrfOpen" style="cursor: pointer;" onclick="showPanel()">
                            <img src="../images/button_open.jpg">
                        </a></td>
                </tr>
            </table>
        </div>
    </div>
</div>

@section scripts
{
    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDTNlc8mcX8hdGZpkkPK1NXVq1PJY1zYs0&sensor=false"></script>
    <script>
        var myplace;
        var directionsDisplay;

        jQuery(document).ready(function ($) {
            //bind to map           

            var locations = new Array();
            //Get data result
            var urlResult = "/Result/search?";
            urlResult += "mode=" + $("#form").val();
            urlResult += "&keyword=" + $("#search").val();
            urlResult += "&currentLocation=" + $("#address").val();
            urlResult += "&categoryid=" + $("#category").val();
            urlResult += "&brandid=" + $("#brand").val();
            urlResult += "&radious=" + $("#range").val();
            urlResult += "&vn0_en1=0";

            $.getJSON(urlResult, null, function (items) {
                for (i in items) {
                    item = items[i];
                    if (item.Latitude != null && item.Longitude != null) {
                        var contentmarker = '<div class="marker"><h2>' + isEmpty(item.ItemName) + '</h2><p>' + isEmpty(item.FullAddress) + '<br/>' + isEmpty(item.Phone) + '</p></div>'
                                     + '<button onclick=\"calcRoute(' + item.Latitude + ',' + item.Longitude + ',\'car\')\">Car</button>'
                                     + '<button onclick=\"calcRoute(' + item.Latitude + ',' + item.Longitude + ',\'walk\')\">Walk</button>'
                                     + '<button onclick=\"calcRoute(' + item.Latitude + ',' + item.Longitude + ',\'bus\')\">Bus</button>';
                        locations.push([item.Latitude, item.Longitude, contentmarker]);
                    }
                }
            });

            range = $("#range").val();

            var address = $("#address").val();
            var geocoder = new google.maps.Geocoder();
            if (geocoder) {
                geocoder.geocode({ 'address': address }, function (results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        //set LatLng current place
                        myplace = results[0].geometry.location;

                        //set map
                        var mapProp = {
                            center: myplace,
                            disableDefaultUI: true,
                            mapTypeId: google.maps.MapTypeId.ROADMAP
                        };
                        var map = new google.maps.Map(document.getElementById("googleMap"), mapProp);

                        //set my city
                        var myCity = new google.maps.Circle({
                            center: myplace,
                            radius: parseInt(range),
                            strokeWeight: 0,
                            fillColor: "#0000FF",
                            fillOpacity: 0.1
                        });
                        myCity.setMap(map);

                        //set direction
                        directionsDisplay = new google.maps.DirectionsRenderer();
                        directionsDisplay.setMap(map);

                        map.fitBounds(myCity.getBounds());
                        markOutLocation(myplace.lat(), myplace.lng(), map, "You are in here", myplace);

                        for (i = 0; i < locations.length; i++) {
                            var compareDistance = return_Distance(myplace, new google.maps.LatLng(locations[i][0], locations[i][1]));
                            if (range >= compareDistance) {
                                markOutLocation(locations[i][0], locations[i][1], map, locations[i][2], myplace);
                            }
                        }

                    } else {
                        alert("Geocode was not successful for the following reason: " + status);
                    }
                });
            }

            //Bind data to property
            BindPropertyData();

        });

        function isEmpty(str) {
            if ((!str || 0 === str.length) == true) {
                return '';
            }
            else {
                return str;
            }
        }

        function markOutLocation(lat, long, map, contentPopup) {
            var place = new google.maps.LatLng(lat, long);
            var marker = new google.maps.Marker({
                position: place,
                title: 'Click to zoom'
            });
            var infowindow = new google.maps.InfoWindow({
                content: contentPopup
            });
            google.maps.event.addListener(marker, 'click', function () {
                infowindow.open(map, marker);
            });
            marker.setMap(map);
        }

        function BindPropertyData() {
            //Bind data to checkbox
            var urlProperty = "/result/PropertyByCategoryID";
            $.getJSON(urlProperty + "?id=-1", null, function (properties) {
                for (i in properties) {
                    property = properties[i];
                    $("#property").append('<input tabindex="' + i + '" type="checkbox" id="' + property.PropertyID + '"><label for="' + property.PropertyID + '">' + property.PropertyName + '</label><br />');
                    $('#' + property.PropertyID).iCheck({
                        checkboxClass: 'icheckbox_square',
                        increaseArea: '20%' // optional
                    });
                }
            });
        }

        function calcRoute(latitude, longitude, type) {
            var directionsService = new google.maps.DirectionsService();

            var start = myplace;
            var end = new google.maps.LatLng(latitude, longitude);
            var travelMode;

            switch (type) {
                case 'car':
                    travelMode = google.maps.DirectionsTravelMode.DRIVING;
                    break;
                case 'bike':
                    travelMode = google.maps.DirectionsTravelMode.BICYCLING;
                    break;
                case 'walk':
                    travelMode = google.maps.DirectionsTravelMode.WALKING;
                    break;
                case 'bus':
                    travelMode = google.maps.DirectionsTravelMode.TRANSIT;
                    break;
            };

            var request = {
                origin: start,
                destination: end,
                travelMode: travelMode
            };
            directionsService.route(request, function (response, status) {
                if (status == google.maps.DirectionsStatus.OK) {
                    directionsDisplay.setDirections(response);
                }
            });
        }

        function rad(x) { return x * Math.PI / 180; }

        function return_Distance(latLng1, latLng2) {
            var R = 6371; // km
            var dLat = rad(latLng2.lat() - latLng1.lat());
            var dLon = rad(latLng2.lng() - latLng1.lng());
            var lat1 = rad(latLng1.lat());
            var lat2 = rad(latLng2.lat());

            var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.sin(dLon / 2) * Math.sin(dLon / 2) * Math.cos(lat1) * Math.cos(lat2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            var d = R * c;
            return d * 1000;
        }

        function hidePanel() {
            var options = {};
            $("#hrfClose").hide("fade", options, 500);
            $("#tbtable").toggle("slide", options, 500, callbackHide);
        }

        function callbackHide() {
            var options = {};
            $("#hrfOpen").removeClass("hidden");
            $("#hrfOpen").show("fade", options, 500);
        };

        function showPanel() {
            var options = {};
            $("#hrfOpen").addClass("hidden");
            $("#tbtable").toggle("slide", options, 500, callbackOpen);
        }

        function callbackOpen() {
            var options = {};
            $("#hrfClose").show("fade", options, 500);
        };

        function displayList() {
            $("#list").removeClass("hidden");
            $("#map").addClass("hidden");

            $("#tabList").removeClass("inactive").addClass("active");
            $("#tabMap").removeClass("active").addClass("inactive");
        }

        function displayMap() {
            $("#map").removeClass("hidden");
            $("#list").addClass("hidden");

            $("#tabMap").removeClass("inactive").addClass("active");
            $("#tabList").removeClass("active").addClass("inactive");
        }
    </script>
}